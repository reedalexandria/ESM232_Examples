---
title: "Exploring Stability in Dynamic Systems"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
library(ggpubr)
```



# Stability


Stability analysis investigates how the  system state changes, particularly focusing on where the system state 'ends up' over time and what happens when there are small perturbations to the system state



# A broader measure of stability

* persistence, CV

* cycling doesn't necessarily mean unstable in an ecological sense

* define stability based on whether or not structure or function stays within expected ranges after a "press" or "pulse" disturbance

* can define metrics, similar to what we did for estimating performance or sensitivity

* multiple metrics can be useful

# Examples?

Ecological systems?

Human systems?

EJ?

# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change..



* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
  
Stability focus..

  * *examine derivatives at different values (simpler, no integration required but just tells you how system will change given a particular state)*
  * *how does systems state evolution vary with inputs/parameters*


# Model versus the real world

Models can help to develop understanding, theory and hypothesis about stability by showing how different assumptions (conceptual models) impact stability

The **WHY** of stability

But the real world (as Kefi et al., 2019) discuss is more complex - but we can learn by understanding simpler models

# Stability analysis for simple differential equations

A mathematical approach..

We can look at how the derivative (rate of change) under different system states to get a picture of when our system will be stable (e.g where small perturbations just bring the system back to a relatively constant state)


One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values

* When the derivative is 0 the system is stable

* Positive derivatives are growth

* Negative are decline

We can use derivatives to see whether and when stability will happen

# Harvest as an example

```{r stability2}

source("../R/dharvest.R")
dharvest

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate = 0.015
gps = list(harv=lowHrate, K=100, r=0.05)

# look at the derivative over a range of forest sizes

findstable = data.frame(Ccurr=seq(from=1, to=100, by=5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
                                                  
ggplot(findstable, aes(Ccurr, dervHlow))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")

# Populations will be stable when derivative is zero!

# look at a different harvest rate
midHrate=0.02
gps = list(harv=midHrate, K=100, r=0.05)
findstable$dervHmid= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
 
# try high rate
highHrate=0.05
gps = list(harv=highHrate, K=100, r=0.05)
findstable$dervHhigh= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, biomass=.x) ))
 

# plot them all together
tmp = gather(findstable, key="HarvestRate", value="value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color=HarvestRate))+geom_point()+geom_hline(yintercept = 0, col="black")+
  labs(x="Forest Biomass (kgC)", y="Forest Growth Rate (kgC/year)")

# notice how with higher harvest rates the stable population will be lower




```

# Stability in changing systems - just looking at dervatives

Knowing the stability can help you understand the dynamics of the system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right
```{r  check}

tm = seq(from=1, to=500)
gps = list(harv=lowHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
  labs(y="Forest Biomass (kgC)", x="Year", title="low harvest rate")
  



gps = list(harv=highHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
 labs(y="Forest Biomass (kgC)", x="Year", title="High Harvest Rate")




```

# In class challenge

We can more formally find stablity by finding the system state when the derivative is zero


What if we have a forest management task -  to make harvest a fixed amount of  carbon but only take it if forest carbon is above a threshold minimum carbon that will insure stability

Think about how you would explore stability here

* use our derivative function based on *dharvestfixed.R*

* assume a forest growth rate of 0.05, a carrying capacity of 1000kg and a harvest rate of 10kg/year

* can you figure out what the two stable values of forest carbon will be without running the ODE

# here's what I did

```{r stability}

source("../R/dharvestfixed.R")

# first lets look at how the derivative varies with the size of forest

carbon = seq(from=0, to=1000)
dcarbon= unlist(carbon %>% map(dharvestfixed,Time=NULL, parms=list(r=0.05, K=1000, mincarbon=0, harv=10)))

a =ggplot(cbind.data.frame(carbon=carbon,dcarbon=dcarbon), aes(carbon, dcarbon))+geom_point()+geom_hline(yintercept = 0, col="red")+
  labs(y="Derivative\n (Rate of change of forest carbon) (kg/C/year)", x="Current Forest Carbon Stock (kgC)")
a 
# try it out with different initial conditions to watch how the system moves to a stable state
tm = seq(from=1, to=500)
Pinitial = 500
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

b=ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 500kgC")
ggarrange(a,b)

#  try smaller starting condition
tm = seq(from=1, to=500)
Pinitial = 150
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

c=ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")

ggarrange(b,a,c)

#  try other stable starting condition
tm = seq(from=1, to=500)

# unstable
Pinitial =275
# stable
Pinitial = 277
gps = list(harv=10, K=1000, r=0.05, mincarbon=0)

res = ode(Pinitial,tm, dharvestfixed, gps )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")

# try a different method
res = ode(Pinitial,tm, dharvestfixed, gps, method="euler" )
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()+
   labs(y="Forest Biomass (kgC)", x="Year", title="Fixed Harvest of 10kg/year\n Starting conditions 1kgC")


```

# Stability 

How do we think about stablity for multiple outputs (e.g. predator/prey)

Populations don't change when derivatives are zero!

What conditions lead to BOTH derivatives being zero

# Stability For *lotvmod*

* dprey = rprey * prey -  alpha * prey * pred
* dpred = eff* alpha * prey * pred - pmort *pred

Make dprey and dpred equal to 0 and rearrange

* pred_i = rprey/alpha
* prey_i = pmort/(eff * alpha)

# Stability For *lotvmodK*

* dprey = rprey * (1-prey/K) * prey -  alpha * prey * pred
* dpred = eff* alpha * prey * pred - pmort * pred

Make dprey and dpred equal to 0 and rearrange

* prey_i = pmort/(eff * alpha)
* pred_i = rprey/alpha * (1-prey_i/K)

Try setting you initial conditions close to these values and see what happens


```{r stabilitynew}

source("../R/lotvmodK.R")
# set parameter list
pars = data.frame(rprey=0.1, alpha=0.6, eff=0.8,pmort=0.4, K=200)

# now lets try initial conditions that will be stable
preyi = with(pars, pmort/(eff*alpha)) 
predi = with(pars, rprey/alpha*(1-preyi/K)) 

preyi
predi
# times when you want to evaluate
days = seq(from=1,to=500)

# lets first see what happens when we start with 1 of each
currpop=c(prey=1, pred=1)
# run our differential equation solver
res = ode(func=lotvmodK, y=currpop, times=days, parms=pars)
# extract the results
res_smallstart = as.data.frame(res) %>% gather(key="animal", value="pop",-time)
# graph both populations over time
p1=ggplot(res_smallstart, aes(time, pop, col=animal))+geom_line()
p1

# lets first see what happens when we start our estimates of stable populations
stablepop = c(prey=preyi, pred=predi)
res = ode(func=lotvmodK, y=stablepop, times=days, parms=pars)
# estract the results
res_stablestart = as.data.frame(res) %>% gather(key="animal", value="pop",-time)
# graph both populations over time
p2=ggplot(res_stablestart, aes(time, pop, col=animal))+geom_line()
p2

# explore with some different parameters

```


# Stablity

* simple mathematical definition - when derivatives are zero
  * algerbra
  * plotting
  
* more complex definitions - think of metrics that looks at
ranges, cycling, return to a population above some threshold after disturbance

* for more complex definitions of stablity you'd need to do the
integration (e.g run the ode solver) and then plot or compute a metric of stability


# Assignment

Consider how you might add hunting  of prey to the predator prey model that we've been using in class

Build this model (e.g add harvesting to the lotvmodK.R), you should make sure that you don't hunt more prey than exist. To ensure that you might also add a minumum prey population input that must be met before hunting is allowed.

Explore how different hunting levels and different minimum prey populations (before hunting is allowed) are likely to effect the stability of the populations of both predator and prey. Use this exploration to recommend a hunting target that will be sustainable (e.g leave you with a stable prey and predator population)

You can assume the following
rprey=0.95, alpha=0.01, eff=0.6,pmort=0.4, K=2000,

A key challenge is how you might want to define stability? Its up to you but you will need to write a sentence to explain why you chose the measure that you did.  It could be something as simple as maintaining a population above some value 50 years into the future.

Its also up to you how you "explore" hunting  - you can simply try different values or do it more formally by running your model across a range of values

Submit the Rmarkdown that documents your exploration (e.g how you tested different hunting level and how you defined a stability metric) and provides you estimated sustainable hunting level. 
